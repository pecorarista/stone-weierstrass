\usepackage{graphicx}
\usepackage[%
    hang,
    flushmargin
]{footmisc}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{amsthm}
\usepackage{cases}
\usepackage{optidef}
\usepackage[
    math-style=ISO
]{unicode-math}
\usepackage{tikz}
\usepackage{tikz-3dplot}
\usepackage{tikz-qtree}
\usepackage{pgfplots}
\usetikzlibrary{%
    patterns,
    intersections,
    calc,
    angles,
    quotes
}

\usepackage{xcolor}
\definecolor{sBlue}{HTML}{0095D9}
\colorlet{sOriginalCurve}{sBlue}

\definecolor{sRed}{HTML}{FF0033}
\colorlet{sApproxCurve}{sRed}

\definecolor{sGreen}{HTML}{138D75}
\colorlet{sSimpleCurve}{sGreen}

\definecolor{sFill}{HTML}{00A381}
\definecolor{sLightGray}{gray}{0.85}

\usepackage[
    % no-math
]{fontspec}
\usepackage[
    deluxe,%
    expert,
    scale=0.95
]{luatexja-preset}

\usepackage{luatexja-ruby}
\setmainfont[%
    Extension=.ttf,
    UprightFont=*,
    ItalicFont=*i,
    BoldFont=*bd,
    BoldItalicFont=*bi,
    Ligatures=Discretionary
]{times}
\setsansfont[
    Extension=.otf,
    UprightFont=*-Light,
    BoldFont=*-Roman,
]{FrutigerLTStd}
\setmathfont{NewComputerModernMath-Book}
\setmathfont[%
    range={%
        cal,
        bfcal
    },
    StylisticSet=1
]{KpMath-Regular.otf}

\ltjnewpreset{book}{%
    mc-m = A-OTF-RyuminPro-Regular.otf,
    % mc-m = NotoSerifJP-Regular.otf,
    % mc-m = HiraMinProN-W3.otf,
    gt-m = BIZUDGothic-Regular.ttf,
    gt-b = BIZUDGothic-Bold.ttf,
    mg-m = MotoyaMaruStd-W5.otf
}
\ltjapplypreset{book}
\setmonojfont{HiraMaruProN-W4}
\ltjsetparameter{%
    jacharrange={%
        -2, % Exclude Greek and Cyrillic letters.
        -3, % Punctuations and miscellaneous symbols.
        -7  % other CJK characters
    },
    alxspmode={`/,allow},
    alxspmode={`#,allow},
    alxspmode={92,allow} % backslash
}
\ltjsetruby{%
    kenten={\bfseries 、},
}

\newtheoremstyle{jplain}%
    {\topsep}%
    {\topsep}%
    {\normalfont}%
    {}%
    {\bfseries\gtfamily\sffamily}%
    {}%
    {5pt}%
    {\thmname{#1}\thmnumber{#2}\thmnote{#3}\ignorespaces}
\newtheoremstyle{jspecial}%
    {\topsep}%
    {\topsep}%
    {\normalfont}%
    {}%
    {\bfseries\gtfamily\sffamily}%
    {}%
    {5pt}%
    {\thmname{#1}\thmnumber{#2\({}^{\symbf{*}}\)}\thmnote{#3}\ignorespaces}
\theoremstyle{jplain}
\newtheorem{theorem}{定理}
\newtheorem{proposition}[theorem]{命題}
\newtheorem{lemma}[theorem]{補題}
\newtheorem{definition}[theorem]{定義}
\newtheorem{example}[theorem]{例}
\newtheorem{axiom}[theorem]{公理}
\newtheorem{corollary}[theorem]{系}
\newtheorem{numberedquote}[theorem]{引用}
\renewcommand{\proofname}{証明}
\renewcommand{\qedsymbol}{\rule{5pt}{10pt}}
\theoremstyle{jspecial}
\newtheorem{specialexample}[theorem]{例}

\usepackage{wtref}
\newref{fig}
\setrefstyle{fig}{prefix=図}
\newref{math}
\setrefstyle{math}{prefix={式~(},suffix={)}}
\newref{definition}
\setrefstyle{definition}{prefix=定義}
\newref{axiom}
\setrefstyle{axiom}{prefix=公理}
\newref{proposition}
\setrefstyle{proposition}{prefix=命題}
\newref{lemma}
\setrefstyle{lemma}{prefix=補題}
\newref{example}
\setrefstyle{example}{prefix=例}
\newref{theorem}
\setrefstyle{theorem}{prefix=定理}
\newref{chapter}
\setrefstyle{chapter}{prefix={第},suffix={章}}
\newref{sec}
\setrefstyle{sec}{prefix={第},suffix={節}}
\newref{corollary}
\setrefstyle{corollary}{prefix=系}
\newref{problem}
\setrefstyle{problem}{prefix=問題}

\usepackage{tcolorbox}
\tcbuselibrary{%
    skins,
    breakable
}
\newtcolorbox{thmbox}{%
    colback=sLightGray,
    before skip=1.3em,
    top=8pt,
    bottom=8pt,
    left=8pt,
    right=8pt,
    boxrule=0pt,
    sharp corners,
    frame hidden
}
\newtcolorbox{quotebox}{%
    breakable,
    colback=sLightGray,
    top=8pt,
    bottom=8pt,
    left=8pt,
    right=8pt,
    boxrule=0pt,
    sharp corners,
    frame hidden
}

\makeatletter
\renewenvironment{proof}[1][\proofname]{\par
    \pushQED{\qed}%
    \normalfont \topsep=1.3em\relax
    \trivlist
    \item[\hskip\labelsep\bfseries\gtfamily#1]\ignorespaces
}{%
    \popQED\endtrivlist\@endpefalse\addvspace{1.3em}
}
\makeatother
\AtBeginDocument{%
    \setlength{\abovedisplayskip}{5pt}%
    \setlength{\belowdisplayskip}{5pt}%
}

% https://note.com/yuw/n/n38dd54fb2169
\begingroup
\catcode`\,=\active
\def\@x@{\def,{\normalcomma\hskip.2em}}
\expandafter\endgroup\@x@%
\mathcode`\,="8000
\def\normalcomma{\mathchar"613B}

\usepackage{enumitem}
\newlist{conditions}{enumerate}{1}
\setlist[conditions]{label=(\arabic*)}

\newlist{inproofconditions}{enumerate}{1}
\setlist[inproofconditions]{label=(\alph*)}

\usepackage{hyperref}
\hypersetup{%
    colorlinks,
    citecolor=sBlue,
    linkcolor=sBlue,
    urlcolor=sBlue
}

\newcommand\mainchapter[1]{\chapter{#1}\thispagestyle{empty}}
\renewcommand{\jsParagraphMark}{}
\renewcommand{\headfont}{\bfseries\gtfamily\sffamily}

\newcommand\tuple[1]{(#1)}
\newcommand\coord[1]{(#1)}
\newcommand\openinterval[1]{(#1)}
\newcommand\absolute[1]{\lvert #1 \rvert}
\newcommand\keyword[1]{{\bfseries\gtfamily\sffamily #1}}
\newcommand\emphchar[1]{\ltjalchar`‹\thinspace{#1}\thinspace\ltjalchar`›}

\newcommand\NaturalNumber{\symbb{N}}
\newcommand\Integer{\symbb{Z}}
\newcommand\Rational{\symbb{Q}}
\newcommand\Real{\symbb{R}}
\newcommand\Complex{\symbb{C}}
\newcommand\PositiveInteger{\symbb{N}_{\mathord{+}}}
\newcommand\NonNegativeReal{\symbb{R}_{\mathord{+}}}
\newcommand\PositiveReal{\symbb{R}_{\mathord{+}\mathord{+}}}

\newcommand\SequenceLikeOpen{\langle}
\newcommand\SequenceLikeClose{\rangle}
\newcommand\Sequence[2]{{\SequenceLikeOpen {#1}_{#2} \SequenceLikeClose}_{#2 \in \PositiveInteger}}
\newcommand\Sequencen[1]{{\SequenceLikeOpen {#1}_n \SequenceLikeClose}_{n \in \PositiveInteger}}
\newcommand\Subsequence[1]{{\SequenceLikeOpen {#1}_{\varphi(n)} \SequenceLikeClose}_{n \in \PositiveInteger}}
\newcommand\Family[3]{{\SequenceLikeOpen {#1}_{#2} \SequenceLikeClose}_{#2 \in #3}}

\newcommand\FamilyLambda[1]{{\SequenceLikeOpen {#1}_\lambda \SequenceLikeClose}_{\lambda \in \Lambda}}

\newcommand\Generatedtopology[1]{\tau\left[#1\right]}
\newcommand\Neighborhood[1]{\symcal{N}_{#1}}
\newcommand\OpenNeighborhood[1]{\symcal{U}_{#1}}

\newcommand\placeholder{\mathord{\text{\char"25CC}}}
\newcommand\powerset[1]{\wp(#1)}
\newcommand\inlinefrac[2]{#1\mathbin{/}#2}
\newcommand\setcomp[1]{{#1}^{\mathsf{c}}}
% https://zrbabbler.hatenablog.com/entry/20120411/1334151482
\newcommand{\relmiddle}[1]{\mathrel{}\middle#1\mathrel{}}

\DeclareMathOperator{\identity}{id}
\DeclareMathOperator{\trace}{trace}
\DeclareMathOperator{\len}{length}
\DeclareMathOperator{\sgn}{sgn}
\DeclareMathOperator{\atantwo}{atan2}
\DeclareMathOperator{\realpart}{Re}
\DeclareMathOperator{\imaginarypart}{Im}
\DeclareMathOperator{\Span}{span}
\newcommand\symdiffsymbol{\mathord{\triangle}}
\newcommand\symdiff[2]{#1\mathbin{\triangle}#2}
\newcommand\formallang[1]{{\treefont\itshape #1}}

\newcommand\header[1]{\multicolumn{1}{c}{\bfseries\gtfamily #1}}
\newcommand\pronunciation[4]{#1 \texttt{#2} [#3] #4．}
\newcommand\primarystress{\mbox{}\char"02C8}
\newcommand\projection[1]{\pi_{#1}}
\renewcommand{\restriction}{\mathrel{\upharpoonright}}

\newcommand\submin[1]{#1_{\text{min}}}

\newcommand\liaison{\hspace*{0.1em}\raisebox{-0.8ex}{\rotatebox{90}{(}}\hspace*{0.1em}}
\newcommand\shortunderscore{\scalebox{0.7}[1]{\_}}
\newcommand\invbreve[1]{#1{\char"032F}}
% \newcommand\symbb[1]{\mathbb{#1}}
% \newcommand\symcal[1]{\mathcal{#1}}
% \newcommand\symbf[1]{\mathbf{#1}}

\newcommand\iseventuallyin[2]{#1 \mathrel{\text{is eventually in}} #2}
\newcommand\justin[1]{\mathrel{\text{in}} #1}
\newcommand\isfrequentlyin[2]{#1 \mathrel{\text{is frequently in}} #2}
\newcommand\oxfordcomma[3]{#1, #2, \text{and }#3}
\newcommand\transpose{\symsfup{T}}
\newcommand\inlinerowvec[3]{(#1\ \ #2\ \ #3)}
\newcommand\inlinecolvec[3]{(#1\ \ #2\ \ #3)^{\transpose}}
\newcommand\origin{\symup{O}}
\newcommand\almosteverywhere{\mathrm{a.e.}}
\newcommand\gateauxderiv[2]{df(#1;\, #2)}
\newcommand\geovec[2]{\overrightarrow{\symup{#1}\symup{#2}}}

\newcommand\refimpliesref[2]{\(\text{#1} \Rightarrow \text{#2}\)}
\newcommand\tpmbase[2]{\left.\frac{\partial}{\partial #1}\right\lvert_{#2}}
\newcommand\tpRnbase[1]{\frac{\partial}{\partial #1}}

\renewcommand{\labelitemii}{\(\circ\)}
\renewcommand{\labelitemiii}{\(\diamond\)}
